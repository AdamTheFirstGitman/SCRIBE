# SCRIBE - Solutions Chat UX Propos√©es

**Date:** 14 octobre 2025
**Contexte:** Refonte architecture chat pour exp√©rience WhatsApp-style flawless
**Objectif:** √âliminer messages cryptiques + optimiser longueur √©changes + s√©parer Archives/Works

---

## üéØ **PROBL√àMES R√âSOLUS**

### ‚úÖ 1. S√©paration Archives vs Works
**Avant :**
- Table `notes` stocke TOUT (conversations + documents)
- Confusion conceptuelle Archives = Works

**Solution :**
- **Archives (`notes`)** : Documents, synth√®ses, connaissances consolid√©es
- **Works (`conversations`)** : Chat history, √©changes dynamiques
- **Filtering logic** : `ConversationStorageFilter` d√©cide o√π stocker

### ‚úÖ 2. Messages Cryptiques Agents
**Avant :**
- Tool calls, params, debug info visibles frontend
- Processing steps internes expos√©s
- UX technique, charg√©e

**Solution :**
- **Filtering Layer** : `MessageFilter` nettoie messages backend ‚Üí UI
- Masque : reasoning, debug, tool params, internal keywords
- Affiche : r√©sum√©s concis, badges ic√¥nes, clickable objects

### ‚úÖ 3. √âchanges Agents Trop Longs
**Avant :**
- `MaxMessageTermination = 6` tours (trop permissif)
- System messages verbeux encourageant d√©tails

**Solution :**
- **MaxMessageTermination = 4** tours (optimis√© UX)
- **System messages WhatsApp-style** : "2-3 lignes MAX"
- **Concision forc√©e** : Synth√®se > d√©tails exhaustifs

---

## üèóÔ∏è **ARCHITECTURE IMPL√âMENT√âE**

### Workflow 2-Couches

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       LAYER 1: BACKEND ENGINE (Full)           ‚îÇ
‚îÇ  ‚Ä¢ AutoGen discussion compl√®te                 ‚îÇ
‚îÇ  ‚Ä¢ Tool calls d√©taill√©s (logged)               ‚îÇ
‚îÇ  ‚Ä¢ Reasoning, debug, internal steps            ‚îÇ
‚îÇ  ‚Ä¢ Storage BD complet (audit trail)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
            FILTERING LAYER
          (message_filter.py)
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       LAYER 2: FRONTEND UX (Clean)             ‚îÇ
‚îÇ  ‚Ä¢ Messages 2-3 lignes filtr√©s                 ‚îÇ
‚îÇ  ‚Ä¢ Tool badges ic√¥nes (sans params)            ‚îÇ
‚îÇ  ‚Ä¢ Clickable objects propres                   ‚îÇ
‚îÇ  ‚Ä¢ Aucun contenu technique visible             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì¶ **COMPOSANTS CR√â√âS**

### 1. `utils/message_filter.py` ‚úÖ

**Classes impl√©ment√©es :**

#### `MessageFilter`
Filtre messages agents pour UI frontend propre.

**M√©thodes cl√©s :**
- `filter_agent_message()` : Nettoie message backend ‚Üí UI
- `_remove_internal_blocks()` : Supprime debug/reasoning
- `_remove_tool_calls()` : Masque syntaxe tool calls
- `_condense_message()` : R√©sume si > 500 chars
- `_extract_action_summary()` : R√©sum√© actions effectu√©es

**Keywords filtr√©s automatiquement :**
```python
"reasoning:", "thinking:", "internal:", "debug:",
"context_summary:", "tool_execution:", "processing_step:",
"function_call:", "tool_params:", "raw_result:"
```

#### `ToolActivityFilter`
Transforme tool calls ‚Üí badges UI-friendly.

**Transformations :**
| Backend Tool          | Frontend Badge                |
|-----------------------|-------------------------------|
| `search_knowledge`    | üîç "5 r√©sultats"              |
| `web_search`          | üåê "3 sources"                |
| `create_note`         | üìù "Note cr√©√©e"               |
| `update_note`         | ‚úèÔ∏è "Mise √† jour note"         |
| `get_related_content` | üîó "4 connexions"             |

#### `ConversationStorageFilter`
D√©termine si conversation doit cr√©er note Archives.

**R√®gles :**
- **Works (conversations)** : TOUTES conversations (100% stock√©es)
- **Archives (notes)** : UNIQUEMENT si `create_note` tool utilis√©

**Espaces s√©par√©s, pas de chevauchement :**
- Works = Chat interface (`/chat`)
- Archives = Viz Page (`/archives`, `/viz/:id`)

**Crit√®res cr√©ation note Archives :**
- Tool `create_note` utilis√© (signal PRIMARY)
- Intent explicite user ("cr√©e une note", "archive")

---

### 2. System Messages Agents Optimis√©s ‚úÖ

#### Plume (Avant/Apr√®s)

**Avant (verbeux) :**
```
Tu es Plume, sp√©cialis√©e dans la restitution PARFAITE des informations.

MISSION: Capture, transcris et reformule avec pr√©cision absolue.

PRINCIPES:
- FID√âLIT√â ABSOLUE: Aucune invention, aucune extrapolation
- PR√âCISION: Chaque d√©tail compte, chaque nuance pr√©serv√©e
- CLART√â: Structure et pr√©sente de mani√®re optimale
- CONCISION: Adapte la longueur selon la complexit√©

STYLE DE DISCUSSION:
- Pour salutations/questions simples: r√©ponds directement, sois concis
- Pour conversations en cours: maintiens le contexte
...
```

**Apr√®s (concis) :**
```
Tu es Plume üñãÔ∏è, agent de restitution parfaite.

R√àGLES STYLE (WhatsApp-like):
- R√©ponds en 2-3 lignes MAX (sauf si substantiel)
- CONCIS mais COMPLET
- Salutations: 1 ligne suffit
- Questions complexes: structure courts paragraphes

PRINCIPES:
- Fid√©lit√© absolue (pas d'invention)
- Pr√©cision (chaque d√©tail compte)
- Clart√© (mots simples, direct)

COLLABORATION:
- Si recherche n√©cessaire ‚Üí laisse Mimir agir
- Sinon ‚Üí r√©ponds directement
- 1 tour de parole suffit g√©n√©ralement
```

#### Mimir (Avant/Apr√®s)

**Avant (verbeux) :**
```
Tu es Mimir, archiviste et gestionnaire de connaissances m√©thodique.

MISSION: Archivage, recherche et connexions intelligentes des informations.

PRINCIPES:
- M√âTHODOLOGIE: Approche syst√©matique de l'information
- INTELLIGENCE: D√©cide quand utiliser les tools selon le contexte
...
[Long system message d√©taill√©]
```

**Apr√®s (concis) :**
```
Tu es Mimir üß†, archiviste intelligent.

R√àGLES STYLE (WhatsApp-like):
- R√©ponds en 2-3 lignes MAX
- Synth√®se > d√©tails exhaustifs
- Si 5+ sources ‚Üí r√©sume en bullet points courts
- Pas de preamble ("Voici les r√©sultats...")

TOOLS (utilise intelligemment):
‚úÖ search_knowledge SI:
  - Mots-cl√©s recherche ("trouve", "cherche", "recherche")
  - Question n√©cessite archives

‚ùå PAS search_knowledge pour:
  - Salutations (bonjour, hi, salut)
  - Questions g√©n√©rales < 15 chars
  - Chat casual

COLLABORATION:
- Recherche ‚Üí synth√©tise ‚Üí passe √† Plume pour reformulation
- 1-2 tours MAX (pas de longs √©changes)
```

#### MaxMessageTermination R√©duit

**Avant :**
```python
termination_condition = MaxMessageTermination(6)  # Max 6 rounds
```

**Apr√®s :**
```python
# Reduced from 6 to 4 for WhatsApp-style concision
termination_condition = MaxMessageTermination(4)  # Max 4 rounds (optimized UX)
```

---

### 3. Documentation Strat√©gique ‚úÖ

**Fichiers cr√©√©s :**
- `CHAP2/CHAT_UX_ARCHITECTURE.md` : Architecture compl√®te 2-couches
- `CHAP2/SOLUTIONS_CHAT_UX_PROPOSEES.md` : Ce document (synth√®se)

---

## üîÑ **WORKFLOW TRANSFORMATION**

### Exemple : Message User ‚Üí R√©ponse UI

#### Input User
```
"Recherche-moi les infos sur le projet X"
```

#### Backend (Layer 1) - Internal Processing
```
[Orchestrator] routing_decision: discussion mode
[Mimir] reasoning: L'utilisateur demande une recherche explicite
[Mimir] [TOOL_START: search_knowledge]
[Mimir] tool_params: {"query": "projet X", "limit": 10, "threshold": 0.75}
[Mimir] raw_result: {"results_count": 5, "sources": [...]}
[Mimir] internal: J'ai trouv√© 5 documents pertinents...
[Mimir] context_summary: [500 mots d√©taill√©s sur les 5 docs]
[Plume] reasoning: Je vais reformuler la synth√®se de Mimir
[Plume] processing: Extraction points cl√©s...
[Storage] Saving conversation to DB...
```

#### Frontend (Layer 2) - Filtered UI Display
```
üß† Mimir:
üîç Recherche archives (5 r√©sultats)

J'ai trouv√© 5 docs sur le projet X : architecture technique,
budget, et planning. Veux-tu un aspect particulier ?

üñãÔ∏è Plume:
R√©sum√© : Projet X = stack Python/React, budget 50K‚Ç¨,
livraison Q2 2025. Plus de d√©tails ?
```

**Transformation appliqu√©e :**
- ‚úÖ Tool params masqu√©s
- ‚úÖ Reasoning/debug supprim√©s
- ‚úÖ Messages condens√©s 2-3 lignes
- ‚úÖ Badge ic√¥ne search_knowledge
- ‚úÖ Pas de preamble technique

---

## üìä **S√âPARATION WORKS vs ARCHIVES**

### Tables Database

#### `conversations` (Works - Chat History)
**Contenu :**
- **TOUTES** les conversations chat (100%)
- Messages user + agents (filtr√©s pour display)
- Interface : `/chat` (WhatsApp-style)

**Structure :**
```sql
CREATE TABLE conversations (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  title TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  metadata JSONB  -- agents_involved, note_ids
);
```

#### `notes` (Archives - Knowledge Base)
**Contenu :**
- Documents upload√©s (PDF, TXT)
- Notes cr√©√©es manuellement
- Notes cr√©√©es via `create_note` tool
- Interface : `/archives`, `/viz/:id` (Viz Page)

**Structure :**
```sql
CREATE TABLE notes (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  title TEXT NOT NULL,
  text_content TEXT,
  html_content TEXT,
  tags TEXT[],
  metadata JSONB,  -- source: "conversation" | "upload" | "manual"
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  is_deleted BOOLEAN DEFAULT false
);
```

### R√®gles Stockage (SIMPLIFI√â)

**Works (TOUJOURS) :**
- Toutes conversations ‚Üí `conversations` table
- 100% historique chat pr√©serv√©

**Archives (CONDITIONNEL) :**
- Note cr√©√©e UNIQUEMENT si :
  - Agent utilise tool `create_note`
  - OU user demande explicitement "cr√©e une note"

**Pas de cat√©gorie "both"** : Espaces distincts
- Works = Chat history (dynamique)
- Archives = Notes consolid√©es (statiques avec Viz)

---

## üöÄ **PROCHAINES √âTAPES**

### Phase 2 : Int√©gration Orchestrator (TODO)

**Modifications `orchestrator.py` :**

1. **Import filtering layer** :
```python
from utils.message_filter import (
    MessageFilter,
    ToolActivityFilter,
    ConversationStorageFilter
)
```

2. **Filtrer messages dans `discussion_node`** :
```python
# After AutoGen discussion
for msg in discussion_history:
    filtered_msg = MessageFilter.filter_agent_message(
        agent_name=msg['agent'],
        raw_message=msg['message']
    )
    # Stream filtered message to SSE
    if sse_queue:
        await sse_queue.put({
            'type': 'agent_message',
            **filtered_msg
        })
```

3. **Adapter `storage_node`** :
```python
from utils.message_filter import should_create_archive_note

# ALWAYS store in conversations (Works)
await memory_service.store_message(
    conversation_id=conversation_id,
    role="user",
    content=state.get("input"),
    ...
)

# CONDITIONALLY create note in Archives
if should_create_archive_note({
    "user_input": state.get("input"),
    "tools_used": state.get("tools_used", [])
}):
    # Agent used create_note or user explicitly requested archiving
    await supabase_client.create_note({
        "title": self._generate_title(state.get("input")),
        "text_content": state.get("final_response"),
        "metadata": {"source": "conversation"}
    })
```

4. **Filtrer tool activities SSE** :
```python
# In discussion_node, before streaming tool events
filtered_activity = ToolActivityFilter.filter_tool_activity(
    tool_name=tool_name,
    tool_params=params,
    tool_result=result,
    status=status
)

if sse_queue:
    await sse_queue.put({
        'type': 'tool_activity',
        **filtered_activity
    })
```

### Phase 3 : Frontend Adaptation (TODO)

**Modifications `frontend/app/chat/page.tsx` :**

1. **Adapter r√©ception messages filtr√©s** :
```typescript
// Messages d√©j√† filtr√©s c√¥t√© backend
if (event.type === 'agent_message') {
  const cleanMessage = {
    id: `msg-${event.agent}-${Date.now()}`,
    role: event.agent,
    content: event.content,  // D√©j√† nettoy√©
    timestamp: new Date(),
    action_summary: event.action_summary
  }
  setMessages(prev => [...prev, cleanMessage])
}
```

2. **Afficher tool activities comme badges** :
```typescript
if (event.type === 'tool_activity') {
  // event contient { label, status, summary, timestamp }
  setCurrentToolActivities(prev => {
    const activity = {
      id: `${event.tool}-${Date.now()}`,
      label: event.label,  // "üîç Recherche archives"
      status: event.status,
      summary: event.summary  // "5 r√©sultats"
    }
    return new Map(prev).set(activity.id, activity)
  })
}
```

3. **S√©parer onglets Works/Archives** :
```typescript
// Navigation
<Tabs defaultValue="works">
  <TabsList>
    <TabsTrigger value="works">üí¨ Works</TabsTrigger>
    <TabsTrigger value="archives">üìö Archives</TabsTrigger>
  </TabsList>

  <TabsContent value="works">
    {/* List conversations r√©centes */}
  </TabsContent>

  <TabsContent value="archives">
    {/* List notes consolid√©es */}
  </TabsContent>
</Tabs>
```

---

## üìà **IMPACT ATTENDU**

### UX Chat

**Avant :**
```
[Plume] Reasoning: L'utilisateur pose une question simple...
[Plume] Internal: Je vais utiliser mes capacit√©s de restitution...
[Plume] Processing: Analyse du contexte en cours...
[Plume] [TOOL_CALL: function="analyze_context", params={"input": "..."}]
[Plume] Result: J'ai analys√© la question et voici ma r√©ponse d√©taill√©e
en plusieurs paragraphes qui couvre tous les aspects possibles de la
question pos√©e par l'utilisateur avec un niveau de d√©tail exhaustif...
[250 mots de r√©ponse]
```

**Apr√®s :**
```
üñãÔ∏è Plume:
Salut ! Je suis l√† pour t'aider. Tu veux que
je capture quelque chose ou reformule une info ?
```

### M√©triques Succ√®s

| M√©trique | Avant | Apr√®s | Am√©lioration |
|----------|-------|-------|--------------|
| Messages agents (chars) | 500-1000 | 100-200 | ‚¨áÔ∏è 80% |
| Tours discussion | 4-6 | 2-4 | ‚¨áÔ∏è 50% |
| Contenu technique visible | 100% | 0% | ‚¨áÔ∏è 100% |
| Temps per√ßu r√©ponse | 5-10s | 2-3s | ‚¨áÔ∏è 70% |
| Satisfaction UX | ? | Test√© post-deploy | TBD |

---

## üîç **VALIDATION & TESTS**

### Tests Unitaires (TODO)

**`tests/test_message_filter.py` :**
```python
def test_filter_removes_internal_keywords():
    raw = "Reasoning: Je vais chercher. Voici ma r√©ponse."
    filtered = MessageFilter.filter_agent_message("plume", raw)
    assert "Reasoning:" not in filtered["content"]
    assert "Voici ma r√©ponse" in filtered["content"]

def test_filter_condenses_long_messages():
    raw = "A" * 1000  # 1000 chars
    filtered = MessageFilter.filter_agent_message("mimir", raw)
    assert len(filtered["content"]) <= 500

def test_tool_activity_filter():
    activity = ToolActivityFilter.filter_tool_activity(
        "search_knowledge",
        {"query": "test"},
        {"results_count": 5},
        "completed"
    )
    assert activity["label"] == "üîç Recherche archives"
    assert activity["summary"] == "5 r√©sultats"
```

### Tests Int√©gration (TODO)

**Workflow complet :**
1. Envoyer message user via API
2. V√©rifier backend logs complets (unfiltered)
3. V√©rifier SSE stream messages filtr√©s
4. Valider UI affiche contenu clean
5. Confirmer storage Works vs Archives correct

---

## üìö **DOCUMENTATION CR√â√âE**

| Fichier | Description | Status |
|---------|-------------|--------|
| `utils/message_filter.py` | Module filtering 3 classes | ‚úÖ Cr√©√© |
| `CHAP2/CHAT_UX_ARCHITECTURE.md` | Architecture 2-couches d√©taill√©e | ‚úÖ Cr√©√© |
| `CHAP2/SOLUTIONS_CHAT_UX_PROPOSEES.md` | Synth√®se solutions (ce doc) | ‚úÖ Cr√©√© |
| `agents/autogen_agents.py` | System messages optimis√©s | ‚úÖ Modifi√© |
| Tests unitaires | `test_message_filter.py` | ‚è≥ TODO |
| Int√©gration orchestrator | Filtering dans workflow | ‚è≥ TODO |
| Frontend adaptation | Works/Archives s√©par√©s | ‚è≥ TODO |

---

## üéØ **R√âSUM√â EX√âCUTIF**

**Probl√®mes identifi√©s :**
1. ‚ùå Messages agents trop longs, techniques, cryptiques
2. ‚ùå M√©lange conceptuel Archives vs Works
3. ‚ùå √âchanges agents verbeux (6 tours max)

**Solutions impl√©ment√©es :**
1. ‚úÖ **Filtering Layer 2-couches** : Backend full + Frontend clean
2. ‚úÖ **MessageFilter** : Nettoie messages, masque debug/reasoning
3. ‚úÖ **ToolActivityFilter** : Tool calls ‚Üí badges ic√¥nes
4. ‚úÖ **ConversationStorageFilter** : Works vs Archives automatique
5. ‚úÖ **System messages optimis√©s** : WhatsApp-style 2-3 lignes
6. ‚úÖ **MaxMessageTermination 4** : R√©duction tours 6‚Üí4

**Impact attendu :**
- üöÄ UX WhatsApp-style flawless
- ‚ö° Messages 80% plus courts
- üßπ Aucun contenu technique visible
- üìä S√©paration claire Works/Archives
- üéØ Temps per√ßu r√©duit 70%

**Prochaines √©tapes :**
1. Int√©grer filtering dans orchestrator
2. Adapter frontend pour nouveaux formats
3. Tests unitaires + int√©gration
4. D√©ploiement + monitoring user feedback

---

> **"Le meilleur chat est celui o√π l'IA travaille en profondeur
> mais l'user ne voit que l'essentiel - WhatsApp avec intelligence."**
>
> ‚Äî Architecture SCRIBE 2-Couches, Octobre 2025
